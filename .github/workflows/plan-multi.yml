name: "Multi Env Plan"
on:
  push:
    branches:
      - "**"
      - "!main"
  pull_request:
    branches: ["main"]

permissions:
  id-token: write
  contents: read
  issues: write
  pull-requests: write
jobs:
  # This workflow contains a single job called "scan"
  scan:
    permissions:
      contents: read # for actions/checkout to fetch code
      security-events: write # for github/codeql-action/upload-sarif to upload SARIF results
      actions: read # only required for a private repository by github/codeql-action/upload-sarif to get the Action run status

    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so follow-up steps can access it
      - uses: actions/checkout@v3

      - name: Checkov GitHub Action
        uses: bridgecrewio/checkov-action@v12
        id: checkov
        with:
          # This will add both a CLI output to the console and create a results.sarif file
          output_format: cli,sarif
          output_file_path: console,results.sarif
          directory: .
          quiet: true # display only failed checks
          soft_fail: true # Dont fail the build
          compact: true

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v2

        # Results are generated only on a success or failure
        # this is required since GitHub by default won't run the next step
        # when the previous one has failed. Security checks that do not pass will 'fail'.
        # An alternative is to add `continue-on-error: true` to the previous step
        # Or 'soft_fail: true' to checkov.
        if: success() || failure()
        with:
          sarif_file: results.sarif
      
      # Add resulting output to PR
      - name: Update Pull Request
        uses: actions/github-script@v6
        if: github.event_name == 'pull_request'
        env:
          #PLAN: "terraform\n${{ steps.plan.outputs.stdout }}"
          CHECKOV: "${{ steps.checkov.outputs.results }}"
        with:
          github-token: ${{ github.token }}
          script: |
            const output = `<details><summary>Show Checkov Results</summary>
            
            ${{ env.CHECKOV }}
            </details>

            *Pushed by: @${{ github.actor }}, Action: ${{ github.event_name }}`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })
            
  plan:
    name: plan
    #runs-on: ubuntu-latest
    uses: ./.github/workflows/plan.yml
    strategy:
      fail-fast: false
      matrix:
        environment: ${{ fromJson(vars.ENVIRONMENTS) }}
    concurrency: ${{ matrix.environment }}
    with:
      ENVIRONMENT_NAME: ${{ matrix.environment }}
      AWS_REGION: ${{ vars.AWS_REGION }}
      TF_VERSION: ${{ vars.TF_VERSION }}
      ROLE_DURATION_SECONDS: 3600
      
    secrets:
      IDENTITY_ROLE: ${{ secrets.IDENTITY_ROLE }}

    
      
