name: "ci-envs"
on:
  push:
    branches:
      - "**"
      - "!main"
  pull_request:
    branches: ["main"]

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  ci-plan:
    name: "ci-plan"
    environment: ${{ matrix.client }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        client: ${{ fromJson(vars.clients) }}
    concurrency: ${{ matrix.client }}

    # Use the Bash shell regardless whether the GitHub Actions runner is ubuntu-latest, macos-latest, or windows-latest
    defaults:
      run:
        shell: bash

    steps:
      # Checkout the repository to the GitHub Actions runner
      - name: Checkout
        uses: actions/checkout@v3

      # Get TF variables from GH environment
      - name: Get TF vars
        uses: ./.github/actions/get-vars
        with:
          CONFIG: ${{ vars.CONFIG }}

      # Runs terraform setup and validation stage
      - name: Setup & Plan Terraform
        uses: ./.github/actions/ci-plan
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ENVIRONMENT_NAME: ${{ matrix.client }}
          AWS_REGION: ${{ vars.AWS_REGION }}
          ROLE_DURATION_SECONDS: 3600
          ROLE_SESSION_NAME: ${{ matrix.client }}
          TF_STATE_BUCKET: ${{ vars.TF_STATE_BUCKET }}
          TF_DYNAMO_TABLE: ${{ vars.TF_DYNAMO_TABLE }}
          TF_VERSION: ${{ vars.TF_VERSION }}
          IDENTITY_ROLE: ${{ secrets.IDENTITY_ROLE }}
